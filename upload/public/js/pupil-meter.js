$(document).ready(function(){var lastUploadedImg;var userImg=document.createElement("img");var imgCanvas=document.getElementById("user-img");var imgCtx=imgCanvas.getContext("2d");var gridCanvas=document.getElementById("grid");var gridCtx=gridCanvas.getContext("2d");gridCtx.strokeStyle="blue";var finalImgCanvas=document.getElementById("final-img");var finalImgCtx=finalImgCanvas.getContext("2d");var outputWidth=960;var outputRatio=1/1;var mode;var gridStep=60;var ratio=1/1;var zoomVal=2.5;var customScale=1;var epReel=62;var epPx=62;var epRMm=epLMm=31;var hPupRMm=hPupLMm=22;var mmToPxH=mmToPxV=1;var defaultFrame={aInt:53,d:18,bInt:33,drageoir:1};var coteAInt=defaultFrame.aInt;var coteD=defaultFrame.d;var coteBInt=defaultFrame.bInt;var drageoir=defaultFrame.drageoir;var cardWidthMm=85.60;var cardHeightMm=53.98;var imgRotation=0;var currentStep=0;var finalStep=6;var isSettingPositions=false;var imgZoomed=false;var gridShown=false;var firstImgLoad=true;var imgDrawn=false;var userPoints=[];var framePoints=[];var noseCenter=[];updateDomElements();$('#img-upload button').on("click",function(){$('#img-input').trigger("click");});$('#img-input').on("change",function(){var uploadedImg=document.getElementById("img-input").files[0];var imgReader=new FileReader();imgReader.addEventListener("load",function(){lastUploadedImg=imgReader.result;firstImgLoad=true;resetUserImg();});if(uploadedImg){imgReader.readAsDataURL(uploadedImg);}});userImg.addEventListener("load",function(){if(userImg.src===""){return;}
var imgWidth=userImg.naturalWidth;var imgHeight=userImg.naturalHeight;var imgRatio=imgWidth/imgHeight;var imgCanvasWidth=imgCanvas.width;var imgCanvasHeight=imgCanvas.height;var canvasRatio=imgCanvasWidth/imgCanvasHeight;imgCtx.save();imgCtx.clearRect(0,0,imgCanvasWidth,imgCanvasHeight);if(imgRotation!==0){imgCtx.translate(imgCanvasWidth/2,imgCanvasHeight/2);imgCtx.rotate(degsToRads(imgRotation));imgCtx.translate(-imgCanvasWidth/2,-imgCanvasHeight/2);}
imgCtx.translate(imgCanvasWidth/2,imgCanvasHeight/2);var imgScale=(imgZoomed)?zoomVal*customScale:customScale;imgCtx.scale(imgScale,imgScale);imgCtx.translate(-imgCanvasWidth/2,-imgCanvasHeight/2);if(imgRatio>canvasRatio){imgCtx.drawImage(userImg,0,(imgCanvasHeight-imgCanvasWidth/imgRatio)/2,imgCanvasWidth,imgCanvasWidth/imgRatio);}
else{imgCtx.drawImage(userImg,(imgCanvasWidth-imgCanvasHeight*imgRatio)/2,0,imgCanvasHeight*imgRatio,imgCanvasHeight);}
imgCtx.restore();if(firstImgLoad){currentStep=0;$('#next button').trigger("click");firstImgLoad=false;}
$('#user-img').removeClass("off");imgDrawn=true;});$('#main-panel').on("wheel",function(e){e.preventDefault();if(currentStep!==1){return;}
customScale-=e.originalEvent.deltaY/2000;drawUserImg();});var lastPosition=[0,0];var lastImgPosition=[0,0];var initialFingerDistance;var initialImgScale=1;var startId;var touchStarted=false;$('#user-img').on("dragstart touchstart click",function(e){e.stopPropagation();if(e.originalEvent.type==="dragstart"){if(currentStep===1){e.originalEvent.dataTransfer.setData('text/plain',"");lastImgPosition=[e.originalEvent.clientX,e.originalEvent.clientY];}}
else if(e.originalEvent.type==="touchstart"){if(currentStep===1){if(e.originalEvent.touches.length===2){var finger1=new Victor(e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY);var finger2=new Victor(e.originalEvent.touches[1].clientX,e.originalEvent.touches[1].clientY);initialFingerDistance=finger1.distance(finger2);initialImgScale=customScale;}
else if(e.originalEvent.touches.length===1){lastImgPosition=[e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY];touchStarted=true;}}}
else if(e.originalEvent.type==="click"){if(currentStep===2){if(!isSettingPositions||userPoints.length>1){return;}
var centerPanelOffsetLeft=$('#main-panel').offset().left;var centerPanelOffsetTop=$('#main-panel').offset().top;userPoints[userPoints.length]=[e.clientX-centerPanelOffsetLeft,e.clientY-centerPanelOffsetTop];if(userPoints.length===1){$('#user-right-eye').css("left",userPoints[0][0]-($('#user-right-eye').width()/2));$('#user-right-eye').css("top",userPoints[0][1]-($('#user-right-eye').height()/2));$('#user-right-eye').removeClass("off");$('#drag-user-right-eye').css("left",userPoints[0][0]-$('#drag-user-right-eye').width());$('#drag-user-right-eye').css("top",userPoints[0][1]);$('#user-img-alert span').addClass("off");$('#user-img-alert span[id^="left"]').removeClass("off");}
if(userPoints.length===2){$('#user-left-eye').css("left",userPoints[1][0]-($('#user-left-eye').width()/2));$('#user-left-eye').css("top",userPoints[1][1]-($('#user-left-eye').height()/2));$('#user-left-eye').removeClass("off");$('#drag-user-left-eye').css("left",userPoints[1][0]);$('#drag-user-left-eye').css("top",userPoints[1][1]);$('#user-img-alert span').addClass("off");$('#adjust-pupils').removeClass("off");$('.user-drags').removeClass("off");$('#main-panel').css("cursor","default");$('#next button').prop("disabled",false);}}}});$('.user-drags, .frame-drags').on("dragstart touchstart",function(e){e.stopPropagation();if(currentStep!==2&&currentStep!==5){return;}
startId=$(this).attr("id");if(e.originalEvent.type==="dragstart"){e.originalEvent.dataTransfer.setData('text/plain',"");lastPosition=[e.originalEvent.clientX,e.originalEvent.clientY];}
else if(e.originalEvent.type==="touchstart"){lastPosition=[e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY];touchStarted=true;}});$('#main-panel').on("dragover touchmove",function(e){if(currentStep!==1&&currentStep!==2&&currentStep!==5){return;}
e.originalEvent.preventDefault();if(e.originalEvent.type==="touchmove"&&e.originalEvent.touches.length===2){if(initialFingerDistance){var finger1=new Victor(e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY);var finger2=new Victor(e.originalEvent.touches[1].clientX,e.originalEvent.touches[1].clientY);var currentFingerDistance=finger1.distance(finger2);customScale=initialImgScale+currentFingerDistance/initialFingerDistance-1;drawUserImg();}}
else{var eventClientX,eventClientY;if(e.originalEvent.type==="dragover"){eventClientX=e.originalEvent.clientX;eventClientY=e.originalEvent.clientY;}
else if(e.originalEvent.type==="touchmove"){eventClientX=e.originalEvent.touches[0].clientX;eventClientY=e.originalEvent.touches[0].clientY;}
if(currentStep===1){if(e.originalEvent.type==="touchmove"&&!touchStarted){return;}
var customDeltaX=eventClientX-lastImgPosition[0];var customDeltaY=eventClientY-lastImgPosition[1];$('#user-img, #final-img').css("left","+="+customDeltaX);$('#user-img, #final-img').css("top","+="+customDeltaY);lastImgPosition=[eventClientX,eventClientY];}
else if(currentStep===2||currentStep===5){if(e.originalEvent.type==="touchmove"&&!touchStarted){return;}
var deltaX=eventClientX-lastPosition[0];var deltaY=eventClientY-lastPosition[1];$('#'+startId.replace("drag-","")).css("left","+="+deltaX);$('#'+startId).css("left","+="+deltaX);if(startId.indexOf("nose-center")===-1){$('#'+startId.replace("drag-","")).css("top","+="+deltaY);$('#'+startId).css("top","+="+deltaY);}
switch(startId.replace("drag-","")){case"user-right-eye":userPoints[0][0]+=deltaX;userPoints[0][1]+=deltaY;break;case"user-left-eye":userPoints[1][0]+=deltaX;userPoints[1][1]+=deltaY;break;case"frame-top-left":framePoints[0][0]+=deltaX;framePoints[0][1]+=deltaY;if(mode==="frame"){updateMmToPx();updateNosePosition();}
break;case"frame-bottom-right":framePoints[1][0]+=deltaX;framePoints[1][1]+=deltaY;if(mode==="frame"){updateMmToPx();updateNosePosition();}
break;case"nose-center":noseCenter[0]+=deltaX;break;}
lastPosition=[eventClientX,eventClientY];}}});$(document).on("drop",function(e){e.originalEvent.preventDefault();startId='';});$(document).on("touchend",function(){touchStarted=false;startId='';initialFingerDistance=0;});$('#rotate-one').on("touchmove",function(e){e.stopPropagation();});var isLongTouching=null;$("input[type='range']").on("touchstart",function(){var _this=$(this);if(!isLongTouching){isLongTouching=setTimeout(function(){_this.trigger("contextmenu");},500);}});$("input[type='range']").on("touchmove",function(){if(isLongTouching){clearTimeout(isLongTouching);isLongTouching=null;}});$("input[type='range']").on("touchend",function(){if(isLongTouching){clearTimeout(isLongTouching);isLongTouching=null;}});$('#next button').on("click",function(){if(currentStep>finalStep-1){return;}
currentStep++;handleCurrentStep();});$('#previous button').on("click",function(){if(currentStep<2){return;}
currentStep--;handleCurrentStep();});$('#reset button').on("click",function(){if(currentStep<2){return;}
currentStep=1;handleCurrentStep();});$('#rotate-right').on("click",function(e){e.stopPropagation();imgRotation=(imgRotation+90)%360;drawUserImg();});$('#rotate-left').on("click",function(e){e.stopPropagation();imgRotation=(imgRotation-90)%360;drawUserImg();});var oldRotationVal=0;$('#rotate-one input').on("input",function(){var newRotationVal=$(this).val();var rotationDelta=newRotationVal-oldRotationVal;imgRotation+=rotationDelta;oldRotationVal=newRotationVal;drawUserImg();});$('#rotate-one input').on("contextmenu",function(e){e.preventDefault();oldRotationVal=0;imgRotation=0;$(this).val(0).trigger("input");});$('#img-zoom').on("click",function(){if(currentStep>5){return;}
toggleZoom();});$('#frame-input').on("input",function(){var ref=$(this).val();if(ref.length<2){return;}
$('.ref').each(function(i){if($(this).text().toLowerCase().indexOf(ref.toLowerCase())===-1){$(this).addClass("off");}
else{$(this).removeClass("off");}});$('#frame-list').removeClass("off");});$('.ref').on("click",function(){var ref=$(this).text();$('#frame-input').val(ref);$.ajax({url:'/cotes',method:"POST",data:{'ref':ref},success:function(cotes){cotes=JSON.parse(cotes);coteAInt=cotes.a_int;coteBInt=cotes.b_int;coteD=cotes.d;drageoir=cotes.drageoir;$('#coteA').val(coteAInt+drageoir*2).focus().blur();$('#coteD').val(coteD).focus().blur();$('#coteB').val(coteBInt+drageoir*2).focus().blur();$('#frame-list').addClass("off");$('#next button').prop("disabled",false);}});});$('input[id^=cote]').on("input",function(){switch($(this).attr("id").replace("cote","")){case"A":coteAInt=parseFloat($(this).val())-2*drageoir;break;case"D":coteD=parseFloat($(this).val());break;case"B":coteBInt=parseFloat($(this).val())-2*drageoir;break;}
if($('#coteA').val()&&$('#coteD').val()&&$('#coteB').val()){$('#next button').prop("disabled",false);}
else{$('#next button').prop("disabled",true);}});$('#select-mode button').on("click",function(e){e.stopPropagation();mode=$(this).parent("div").attr("id").replace("-mode","");currentStep++;handleCurrentStep();});$(window).on("resize orientationchange",function(){updateDomElements();});$('body').on("touchmove",function(e){e.preventDefault();});function handleCurrentStep(){$('#user-img-alert span').addClass("off");if(currentStep===0||currentStep>finalStep){return;}
if(currentStep>1){$('#previous button, #reset button').prop("disabled",false);}
else{$('#previous button, #reset button').prop("disabled",true);}
if(currentStep<3){userPoints=[];coteAInt=defaultFrame.aInt;coteD=defaultFrame.d;coteBInt=defaultFrame.bInt;drageoir=defaultFrame.drageoir;$('#coteA, #coteD, #coteB, #frame-input').val("");}
if(currentStep<6){framePoints=[];updateMeasures();}
if(currentStep===2||currentStep===3||currentStep===4||currentStep>=finalStep){$('#next button').prop("disabled",true);}
else{$('#next button').prop("disabled",false);}
if(currentStep===1){$('.img-rot, #user-img-alert, #nav-btns').removeClass("off");resetUserImg();drawGrid();gridShown=true;}
else{$('.img-rot').addClass("off");}
if(currentStep===2){isSettingPositions=true;$('#main-panel').css("cursor","crosshair");$('#user-img-alert span[id^="right"]').removeClass("off");}
else{$('#main-panel').css("cursor","default");$('.set-pupils').addClass("off");}
if(currentStep===3){updatePupilDistance();if($('#coteA').val()&&$('#coteD').val()&&$('#coteB').val()){$('#next button').prop("disabled",false);}
$('#set-ref').removeClass("off");$('#frame-list').parent("div").removeClass("off");}
else{$('#frame-list').parent("div").addClass("off");}
if(currentStep===4){$('#set-mode, #select-mode').removeClass("off");}
else{$('#select-mode').addClass("off");}
if(currentStep===5){var zoomCoef=(imgZoomed)?zoomVal:1;var hPup=(userPoints[0][1]+userPoints[1][1])/2;if(mode==="frame"){$('#set-frame').removeClass("off");framePoints[0]=[userPoints[0][0]-((coteAInt+4)*mmToPxH*zoomCoef)/2,userPoints[0][1]-(coteBInt*mmToPxV*zoomCoef*0.38)];framePoints[1]=[userPoints[0][0]+((coteAInt-4)*mmToPxH*zoomCoef)/2,userPoints[0][1]+(coteBInt*mmToPxV*zoomCoef*0.62)];noseCenter=[framePoints[1][0]+drageoir*mmToPxH*zoomCoef+coteD*mmToPxH*zoomCoef/2,hPup+10*mmToPxV*zoomCoef];}
else if(mode==="card"){$('#set-card').removeClass("off");noseCenter=[userPoints[0][0]+epPx*zoomCoef/2,hPup+10*mmToPxV*zoomCoef];framePoints[0]=[noseCenter[0]-cardWidthMm*mmToPxH*zoomCoef/2,hPup+40*mmToPxV*zoomCoef];framePoints[1]=[noseCenter[0]+cardWidthMm*mmToPxH*zoomCoef/2,hPup+(40+cardHeightMm)*mmToPxV*zoomCoef];}
setFramePosition();setNoseCenterPosition();$('.set-frame').removeClass("off");}
else{$('.set-frame, #nose-center').addClass("off");}
if(currentStep===6){if(framePoints.length!==2){return;}
updateMeasures();triggerFinalImgDrawing();$('#user-img-alert, #img-zoom, #next').addClass("off");$('#final-img').css("z-index","10");}
else{finalImgCtx.clearRect(0,0,finalImgCanvas.width,finalImgCanvas.height);$('#user-img-alert, #img-zoom, #next').removeClass("off");$('#save-link').addClass("off");$('#final-img').css("z-index","0");}}
function setFramePosition(){if(framePoints[0]){$('#frame-top-left').css("left",framePoints[0][0]);$('#frame-top-left').css("top",framePoints[0][1]);$('#drag-frame-top-left').css("left",framePoints[0][0]-$('#drag-frame-top-left').width());$('#drag-frame-top-left').css("top",framePoints[0][1]-$('#drag-frame-top-left').height());}
if(framePoints[1]){$('#frame-bottom-right').css("left",framePoints[1][0]-$('#frame-bottom-right').width());$('#frame-bottom-right').css("top",framePoints[1][1]-$('#frame-bottom-right').height());$('#drag-frame-bottom-right').css("left",framePoints[1][0]);$('#drag-frame-bottom-right').css("top",framePoints[1][1]);}}
function setNoseCenterPosition(){$('#nose-center').css("left",noseCenter[0]-$('#nose-center').width()/2);$('#nose-center').css("top",noseCenter[1]-$('#nose-center').height()/2);$('#drag-nose-center').css("left",noseCenter[0]-$('#drag-nose-center').width()/2);$('#drag-nose-center').css("top",noseCenter[1]-$('#nose-center').height()/2-$('#drag-nose-center').height());}
function handleZoom(){var offsetLeft=$('#user-img').offset().left;var offsetTop=$('#user-img').offset().top;var centerPanelOffsetLeft=$('#main-panel').offset().left;var centerPanelOffsetTop=$('#main-panel').offset().top;var imgCenterPositionX=$('#user-img').width()/2+offsetLeft;var imgCenterPositionY=$('#user-img').height()/2+offsetTop;if(userPoints[0]){var rightEyeDeltaX=userPoints[0][0]+centerPanelOffsetLeft-imgCenterPositionX;var rightEyeDeltaY=userPoints[0][1]+centerPanelOffsetTop-imgCenterPositionY;if(imgZoomed){userPoints[0][0]+=(zoomVal-1)*rightEyeDeltaX;userPoints[0][1]+=(zoomVal-1)*rightEyeDeltaY;$('#user-right-eye, #drag-user-right-eye').css("left","+="+(zoomVal-1)*rightEyeDeltaX);$('#user-right-eye, #drag-user-right-eye').css("top","+="+(zoomVal-1)*rightEyeDeltaY);}
else{userPoints[0][0]+=rightEyeDeltaX*(1-zoomVal)/zoomVal;userPoints[0][1]+=rightEyeDeltaY*(1-zoomVal)/zoomVal;$('#user-right-eye, #drag-user-right-eye').css("left","+="+rightEyeDeltaX*(1-zoomVal)/zoomVal);$('#user-right-eye, #drag-user-right-eye').css("top","+="+rightEyeDeltaY*(1-zoomVal)/zoomVal);}}
if(userPoints[1]){var leftEyeDeltaX=userPoints[1][0]+centerPanelOffsetLeft-imgCenterPositionX;var leftEyeDeltaY=userPoints[1][1]+centerPanelOffsetTop-imgCenterPositionY;if(imgZoomed){userPoints[1][0]+=(zoomVal-1)*leftEyeDeltaX;userPoints[1][1]+=(zoomVal-1)*leftEyeDeltaY;$('#user-left-eye, #drag-user-left-eye').css("left","+="+(zoomVal-1)*leftEyeDeltaX);$('#user-left-eye, #drag-user-left-eye').css("top","+="+(zoomVal-1)*leftEyeDeltaY);}
else{userPoints[1][0]+=leftEyeDeltaX*(1-zoomVal)/zoomVal;userPoints[1][1]+=leftEyeDeltaY*(1-zoomVal)/zoomVal;$('#user-left-eye, #drag-user-left-eye').css("left","+="+leftEyeDeltaX*(1-zoomVal)/zoomVal);$('#user-left-eye, #drag-user-left-eye').css("top","+="+leftEyeDeltaY*(1-zoomVal)/zoomVal);}}
var frameLandmarkWidth,frameLandmarkHeight,noseCenterHeight;var zoomCoef=(imgZoomed)?zoomVal:1/zoomVal;frameLandmarkWidth=$('#frame-top-left').width()*zoomCoef;frameLandmarkHeight=$('#frame-top-left').height()*zoomCoef;noseCenterHeight=$('#nose-center').height()*zoomCoef;$('#frame-top-left, #frame-bottom-right').width(frameLandmarkWidth);$('#frame-top-left, #frame-bottom-right').height(frameLandmarkHeight);$('#nose-center').height(noseCenterHeight);if(framePoints[0]){var leftFrameDeltaX=framePoints[0][0]+centerPanelOffsetLeft-imgCenterPositionX;var leftFrameDeltaY=framePoints[0][1]+centerPanelOffsetTop-imgCenterPositionY;if(imgZoomed){framePoints[0][0]+=(zoomVal-1)*leftFrameDeltaX;framePoints[0][1]+=(zoomVal-1)*leftFrameDeltaY;}
else{framePoints[0][0]+=leftFrameDeltaX*(1-zoomVal)/zoomVal;framePoints[0][1]+=leftFrameDeltaY*(1-zoomVal)/zoomVal;}}
if(framePoints[1]){var rightFrameDeltaX=framePoints[1][0]+centerPanelOffsetLeft-imgCenterPositionX;var rightFrameDeltaY=framePoints[1][1]+centerPanelOffsetTop-imgCenterPositionY;if(imgZoomed){framePoints[1][0]+=(zoomVal-1)*rightFrameDeltaX;framePoints[1][1]+=(zoomVal-1)*rightFrameDeltaY;}
else{framePoints[1][0]+=rightFrameDeltaX*(1-zoomVal)/zoomVal;framePoints[1][1]+=rightFrameDeltaY*(1-zoomVal)/zoomVal;}}
setFramePosition();if(noseCenter){var noseDeltaX=noseCenter[0]+centerPanelOffsetLeft-imgCenterPositionX;var noseDeltaY=noseCenter[1]+centerPanelOffsetTop-imgCenterPositionY;if(imgZoomed){noseCenter[0]+=(zoomVal-1)*noseDeltaX;noseCenter[1]+=(zoomVal-1)*noseDeltaY;}
else{noseCenter[0]+=noseDeltaX*(1-zoomVal)/zoomVal;noseCenter[1]+=noseDeltaY*(1-zoomVal)/zoomVal;}
setNoseCenterPosition();}
if(imgZoomed){gridStep/=zoomVal;}
else{gridStep*=zoomVal;}
if(gridShown){drawGrid();}}
function updatePupilDistance(){if(userPoints.length!==2){return;}
var rightEyeVector=new Victor(userPoints[0][0],userPoints[0][1]);var leftEyeVector=new Victor(userPoints[1][0],userPoints[1][1]);epPx=leftEyeVector.distance(rightEyeVector);if(imgZoomed){epPx/=zoomVal;}
mmToPxH=mmToPxV=epPx/epReel;}
function updateMeasures(){if(framePoints.length!==2){$('#epR').text("");$('#epL').text("");$('#hR').text("");$('#hL').text("");$('#cotes-alert').addClass("off");return;}
updateMmToPx();var zoomCoef=(imgZoomed)?zoomVal:1;if(mode==="frame"){var frameBottom=framePoints[1][1]+(drageoir*mmToPxV*zoomCoef);var hPupRPx=Math.abs(frameBottom-userPoints[0][1]);var hPupLPx=Math.abs(frameBottom-userPoints[1][1]);hPupRPx/=zoomCoef;hPupLPx/=zoomCoef;hPupRMm=hPupRPx/mmToPxV;hPupLMm=hPupLPx/mmToPxV;}
else if(mode==="card"){hPupRMm=hPupLMm=(coteBInt+(drageoir*2))/2+2;}
var epRPx=Math.abs(userPoints[0][0]-noseCenter[0]);var epLPx=Math.abs(userPoints[1][0]-noseCenter[0]);epRPx/=zoomCoef;epLPx/=zoomCoef;epRMm=epRPx/mmToPxH;epLMm=epLPx/mmToPxH;$('#epR').text(Math.round(epRMm*2)/2);$('#epL').text(Math.round(epLMm*2)/2);$('#hR').text(Math.round(hPupRMm*2)/2);$('#hL').text(Math.round(hPupLMm*2)/2);$('#cotes-alert').removeClass("off");}
function updateMmToPx(){var zoomCoef=(imgZoomed)?zoomVal:1;if(mode==="frame"){var coteAIntPx=Math.abs(framePoints[1][0]-framePoints[0][0]);var coteBIntPx=Math.abs(framePoints[1][1]-framePoints[0][1]);coteAIntPx/=zoomCoef;coteBIntPx/=zoomCoef;mmToPxH=coteAIntPx/coteAInt;mmToPxV=coteBIntPx/coteBInt;}
else if(mode==="card"){var cardWidthPx=Math.abs(framePoints[1][0]-framePoints[0][0]);var cardHeightPx=Math.abs(framePoints[1][1]-framePoints[0][1]);cardWidthPx/=zoomCoef;cardHeightPx/=zoomCoef;mmToPxH=cardWidthPx/cardWidthMm;mmToPxV=cardHeightPx/cardHeightMm;}}
function updateNosePosition(){var zoomCoef=(imgZoomed)?zoomVal:1;var hPup=(userPoints[0][1]+userPoints[1][1])/2;noseCenter=[framePoints[1][0]+drageoir*mmToPxH*zoomCoef+coteD*mmToPxH*zoomCoef/2,hPup+10*mmToPxV*zoomCoef];$('#drag-nose-center').css("left",noseCenter[0]-$('#drag-nose-center').width()/2);$('#nose-center').css("left",noseCenter[0]-$('#nose-center').width()/2);}
function drawUserImg(){if(lastUploadedImg){imgDrawn=false;userImg.src="";userImg.src=lastUploadedImg;}}
function resetUserImg(){$('#user-img').addClass("off");customScale=1;lastImgPosition=[0,0];$('#rotate-one input').trigger("contextmenu");if(imgZoomed){toggleZoom();}
else{drawUserImg();}
$('#user-img, #final-img').css({"left":($('#main-panel').width()-$('#user-img').width())/2,"top":($('#main-panel').height()-$('#user-img').height())/2});}
function drawGrid(){var gridWidth=$('#grid').width();var gridHeight=$('#grid').height();gridCtx.clearRect(0,0,gridWidth,gridHeight);gridCtx.beginPath();for(var i=1;i<gridStep;i++){gridCtx.moveTo((i/gridStep)*gridWidth,0);gridCtx.lineTo((i/gridStep)*gridWidth,gridHeight);gridCtx.moveTo(0,(i/gridStep)*gridHeight);gridCtx.lineTo(gridWidth,(i/gridStep)*gridHeight);}
gridCtx.stroke();gridCtx.lineWidth=5;gridCtx.beginPath();var zoomCoef=(imgZoomed)?zoomVal:1;gridCtx.ellipse(gridWidth/2,gridHeight/2.2,zoomCoef*gridHeight/3.2,zoomCoef*gridHeight/5,Math.PI/2,0,Math.PI*2);gridCtx.stroke();gridCtx.lineWidth=1;}
function triggerFinalImgDrawing(){if(imgZoomed){toggleZoom();var waitingForUserImg=setInterval(function(){if(imgDrawn){clearInterval(waitingForUserImg);drawFinalImg();}},20);}
else{drawFinalImg();}}
function drawFinalImg(){finalImgCtx.drawImage(imgCanvas,0,0);var deltaOffsetLeft=$('#main-panel').offset().left-$('#user-img').offset().left;var deltaOffsetTop=$('#main-panel').offset().top-$('#user-img').offset().top;var rightEyePosition=[userPoints[0][0]+deltaOffsetLeft,userPoints[0][1]+deltaOffsetTop];var leftEyePosition=[userPoints[1][0]+deltaOffsetLeft,userPoints[1][1]+deltaOffsetTop];var frameTopLeftPosition=[framePoints[0][0]+deltaOffsetLeft,framePoints[0][1]+deltaOffsetTop];var frameBottomRightPosition=[framePoints[1][0]+deltaOffsetLeft,framePoints[1][1]+deltaOffsetTop];var nosePosition=[noseCenter[0]+deltaOffsetLeft,(userPoints[0][1]+userPoints[1][1])/2+deltaOffsetTop];finalImgCtx.strokeStyle="green";finalImgCtx.beginPath();finalImgCtx.moveTo(rightEyePosition[0]-10,rightEyePosition[1]);finalImgCtx.lineTo(rightEyePosition[0]+10,rightEyePosition[1]);finalImgCtx.moveTo(rightEyePosition[0],rightEyePosition[1]-10);finalImgCtx.lineTo(rightEyePosition[0],rightEyePosition[1]+10);finalImgCtx.moveTo(leftEyePosition[0]-10,leftEyePosition[1]);finalImgCtx.lineTo(leftEyePosition[0]+10,leftEyePosition[1]);finalImgCtx.moveTo(leftEyePosition[0],leftEyePosition[1]-10);finalImgCtx.lineTo(leftEyePosition[0],leftEyePosition[1]+10);finalImgCtx.stroke();finalImgCtx.setLineDash([5,2]);finalImgCtx.beginPath();finalImgCtx.moveTo(nosePosition[0],nosePosition[1]-60);finalImgCtx.lineTo(nosePosition[0],nosePosition[1]+100);finalImgCtx.stroke();finalImgCtx.strokeStyle="blue";finalImgCtx.beginPath();finalImgCtx.moveTo(frameTopLeftPosition[0],frameTopLeftPosition[1]-20);finalImgCtx.lineTo(frameTopLeftPosition[0],frameBottomRightPosition[1]+20);finalImgCtx.moveTo(frameBottomRightPosition[0],frameTopLeftPosition[1]-20);finalImgCtx.lineTo(frameBottomRightPosition[0],frameBottomRightPosition[1]+20);finalImgCtx.moveTo(frameTopLeftPosition[0]-20,frameTopLeftPosition[1]);finalImgCtx.lineTo(frameBottomRightPosition[0]+20,frameTopLeftPosition[1]);finalImgCtx.moveTo(frameTopLeftPosition[0]-20,frameBottomRightPosition[1]);finalImgCtx.lineTo(frameBottomRightPosition[0]+20,frameBottomRightPosition[1]);finalImgCtx.stroke();finalImgCtx.font="bold 13px sans-serif";finalImgCtx.fillStyle="white";finalImgCtx.fillText("1/2 Ep : "+Math.round(epRMm*2)/2+" mm",rightEyePosition[0]-35,frameBottomRightPosition[1]+30);finalImgCtx.fillText("H : "+Math.round(hPupRMm*2)/2+" mm",rightEyePosition[0]-35,frameBottomRightPosition[1]+47);finalImgCtx.fillText("1/2 Ep : "+Math.round(epLMm*2)/2+" mm",leftEyePosition[0]-35,frameBottomRightPosition[1]+30);finalImgCtx.fillText("H : "+Math.round(hPupLMm*2)/2+" mm",leftEyePosition[0]-35,frameBottomRightPosition[1]+47);var savedImgCanvas=document.createElement("canvas");savedImgCanvas.height=$('#user-img').height()*0.4;savedImgCanvas.width=savedImgCanvas.height*outputRatio;var savedImgCtx=savedImgCanvas.getContext("2d");var imgCenter=[$('#main-panel').width()/2,$('#main-panel').height()/2];var finalImgCanvasStart=[parseFloat($('#final-img').css("left")),parseFloat($('#final-img').css("top"))];var savedImgCanvasStart=[imgCenter[0]-savedImgCanvas.width/2,imgCenter[1]-savedImgCanvas.height*0.3];var sx=(finalImgCanvasStart[0]<savedImgCanvasStart[0])?savedImgCanvasStart[0]-finalImgCanvasStart[0]:0;var sy=(finalImgCanvasStart[1]<savedImgCanvasStart[1])?savedImgCanvasStart[1]-finalImgCanvasStart[1]:0;var swidth=(finalImgCanvasStart[0]<savedImgCanvasStart[0])?finalImgCanvasStart[0]+finalImgCanvas.width-savedImgCanvasStart[0]:savedImgCanvasStart[0]+savedImgCanvas.width-finalImgCanvasStart[0];var sheight=(finalImgCanvasStart[1]<savedImgCanvasStart[1])?finalImgCanvasStart[1]+finalImgCanvas.height-savedImgCanvasStart[1]:savedImgCanvasStart[1]+savedImgCanvas.height-finalImgCanvasStart[1];var x=(finalImgCanvasStart[0]<savedImgCanvasStart[0])?0:finalImgCanvasStart[0]-savedImgCanvasStart[0];var y=(finalImgCanvasStart[1]<savedImgCanvasStart[1])?0:finalImgCanvasStart[1]-savedImgCanvasStart[1];savedImgCtx.drawImage(finalImgCanvas,sx,sy,swidth,sheight,x,y,swidth,sheight);var outputImgCanvas=document.createElement("canvas");outputImgCanvas.width=outputWidth;outputImgCanvas.height=outputWidth/outputRatio;var outputImgCtx=outputImgCanvas.getContext("2d");outputImgCtx.drawImage(savedImgCanvas,0,0,outputImgCanvas.width,outputImgCanvas.height);$('#save-link').attr("href",outputImgCanvas.toDataURL()).removeClass("off");}
function toggleZoom(){imgZoomed=(imgZoomed)?false:true;$('#img-zoom i').toggleClass("off");drawUserImg();handleZoom();}
function degsToRads(alpha){return alpha*Math.PI/180;}
function updateDomElements(){var canvasWidth,canvasHeight;var availableHeight=$('#main-panel').height();var neededWidth=availableHeight*ratio;if(neededWidth>$('#main-panel').width()){canvasWidth=$('#main-panel').width();canvasHeight=canvasWidth/ratio;}
else{canvasWidth=neededWidth;canvasHeight=availableHeight;}
$('canvas').width(canvasWidth).height(canvasHeight).attr("width",canvasWidth).attr("height",canvasHeight);$('canvas').css("left",($('#main-panel').width()-canvasWidth)/2);$('canvas').css("top",($('#main-panel').height()-canvasHeight)/2);if(userImg){drawUserImg();}
if(gridShown){drawGrid();}
if(currentStep>1){$('#reset button').trigger("click");handleCurrentStep();}}});